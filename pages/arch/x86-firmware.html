<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      (function () {
        const base = document.createElement("base");
        if (location.hostname.includes("github.io")) {
          base.href = `/HackBook/`;
        } else {
          const pathSegments = window.location.pathname
            .split("/")
            .filter((element) => element !== "");
          const index = pathSegments.indexOf("HackBook");
          pathSegments.splice(index + 1, pathSegments.length - (index + 1));
          base.href = pathSegments.join("/") + "/";
        }
        document.head.appendChild(base);
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="assets\images\hacker.jpg" />

    <title>HackBook | x86 Firmware</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Prism JS -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-nasm.min.js"></script>
    <!-- <link rel="stylesheet" href="https://unpkg.com/dracula-prism/dist/css/dracula-prism.css"> -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/prism-themes@1.6.0/themes/prism-duotone-sea.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/prismjs/plugins/command-line/prism-command-line.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/prismjs/plugins/command-line/prism-command-line.min.js"></script>
    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <script src="assets\scripts\main.js"></script>
    <script src="assets\scripts\cpuid.js"></script>
    <script src="assets\scripts\pcie.js"></script>
    <link rel="stylesheet" href="assets\styles\styles.css" />
    <link rel="stylesheet" href="assets\styles\cpuid.css" />
    <link rel="stylesheet" href="assets\styles\pcie.css" />
  </head>
  <body>
    <!-- Main Content -->
    <div class="content">
        <h1>x86 Firmware</h1>
        <hr />
        <h2 id="pci-express">PCIe</h2>
        <h3 id="pci-topology">PCI Topology</h3>
        <ul>
          <li><u>Bus</u>: PCI has up to 256 (8 bits to encode)
            <ul>
              <li><u>PCI Bridge</u>: used to connect PCI buses</li>
              <li><u>PCI Switch</u>: same as bridge but for PCIe (note: if using PCIe to PCI use a bridge)</li>
              <li><u>Bus 0</u>: used by Intel/AMD CPU/PCH/ICH/MCH-internal hardware blocks</li>
            </ul>
          </li>
          <li><u>Device</u>: each bus has up to 32 (5 bits to encode)</li>
          <li><u>Function</u>: each device has up to 8 (3 bits to encode)</li>
        </ul>
        <img src="https://d9xyzjwjgfkc2g.archive.ph/4N1fd/1cf4eafd328b58577cfe8edcac87515b68d57ebd.jpg" alt="PCI Evolution diagram" class="img-fluid" />
        <br><br>
        <h4 id="pci-enumeration">PCI Enumeration</h4>
        <pre class="command-line"
            data-user="hacker"
            data-host="remotehost"
            data-output="2-16"><code class="language-bash">python3 chipsec_util.py pci enumerate
BDF     | VID:DID   | Vendor                       | Device
-------------------------------------------------------------------------
00:00.0 | 8086:0C00 | Intel Corporation            | 4th Gen Core Processor DRAM Controller
00:01.0 | 8086:0C01 | Intel Corporation            | Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller
00:02.0 | 8086:0412 | Intel Corporation            | Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller
00:03.0 | 8086:0C0C | Intel Corporation            | Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller
00:14.0 | 8086:8C31 | Intel Corporation            | 8 Series/C220 Series Chipset Family USB xHCI
00:16.0 | 8086:8C3A | Intel Corporation            | 8 Series/C220 Series Chipset Family MEI Controller #1
00:19.0 | 8086:153A | Intel Corporation            | Ethernet Connection I217-LM
00:1A.0 | 8086:8C2D | Intel Corporation            | 8 Series/C220 Series Chipset Family USB EHCI #2
00:1B.0 | 8086:8C20 | Intel Corporation            | 8 Series/C220 Series Chipset High Definition Audio Controller
00:1D.0 | 8086:8C26 | Intel Corporation            | 8 Series/C220 Series Chipset Family USB EHCI #1
00:1F.0 | 8086:8C4E | Intel Corporation            | Q87 Express LPC Controller
00:1F.2 | 8086:8C02 | Intel Corporation            | 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode]
00:1F.3 | 8086:8C22 | Intel Corporation            | 8 Series/C220 Series Chipset Family SMBus Controller</code></pre>
        <h3 id="pci-address-spaces">PCI Address Spaces</h3>
        <ul>
          <li><u>PCI Configuration Space (Required)</u>: up to 256 bytes for PCI, extended to 4KB for PCIe</li>
          <li><u>PCI MMIO Space (Optional)</u>: PCI device-dependent memory</li>
          <li><u>PCI Port IO Space (Optional)</u>: same as MMIO just PIO access</li>
        </ul>
        <h4>PCI Configuration Space Dump</h4>
        <pre class="command-line"
            data-user="hacker"
            data-host="remotehost"
            data-output="2-19"><code class="language-bash">python3 chipsec_util.py pci dump 0 0 0
[CHIPSEC] PCI device 00:00.00 configuration:
    _00__01__02__03__04__05__06__07__08__09__0A__0B__0C__0D__0E__0F__
00 | 86  80  36  9A  06  01  90  00  05  00  00  06  00  00  00  00
10 | 00  00  00  00  00  00  00  00  00  00  00  00  00  00  00  20
20 | 00  00  00  00  00  00  00  00  00  00  00  00  86  80  70  72
30 | 00  00  00  00  00  00  00  00  00  00  00  00  00  00  00  00
40 | 01  10  DA  FE  00  00  00  00  01  00  DC  FE  00  00  00  00
50 | C1  FE  00  00  F1  80  02  00  C7  00  20  50  E7  00  00  4B
60 | 01  00  00  C0  00  00  00  00  01  00  DA  FE  00  00  00  00
70 | 08  02  00  01  00  04  00  00  00  00  00  00  88  06  44  00
80 | 30  33  33  33  33  33  33  10  00  00  00  00  00  00  00  00
90 | 08  02  00  01  00  04  00  00  1A  02  00  01  00  04  00  00
A0 | 01  00  00  00  04  00  00  00  01  00  C0  AF  04  00  00  00
B0 | 01  00  80  4C  01  00  00  4C  01  00  00  4B  01  00  40  50
C0 | 00  00  00  00  00  00  00  00  00  00  00  00  00  00  00  00
D0 | 1A  02  00  01  00  04  00  00  00  00  00  00  00  00  00  00
E0 | 09  00  14  01  58  24  00  62  00  00  24  30  0B  02  40  06
F0 | 00  90  1F  00  1D  0F  01  00  00  00  00  00  00  00  00  00</code></pre>

      <h3 id="pci-config-address-space">PCI Config Address Space</h3>
      <ul>
        <li><u>BDFO</u>: <b>B</b>us:<b>D</b>evice<b>.F</b>unction<b> O</b>ffset</li>
        <li><u>Access Methods</u>: 
          <ul>
            <li>PCI Config Space: Port IO or MMIO</li>
            <li>PCIe Extended Config Space: MMIO only</li>
          </ul>
        </li>
      </ul>
      <h4>Port IO Config Access</h4>
      <ul>
        <li><u>CONFIG_ADDRESS</u>: 
          <ul>
            <li>Address: 0xCF8</li>
            <li>Size: 32 bits</li>
            <li>Register Layout:</li>
          </ul>
          <div class="pci-converter-container">
      <div class="converter-inputs">
        <div class="input-group">
          <label for="configRegInput">CONFIG_ADDRESS Register Value:</label>
          <input type="text" id="configRegInput" placeholder="e.g., 0x80000f8f0" class="converter-input">
        </div>
        <div class="input-group">
          <label for="bdfoInput">BDFO (Bus:Device.Function Offset):</label>
          <input type="text" id="bdfoInput" placeholder="e.g., 00:1f.7 0xf0" class="converter-input">
        </div>
      </div>
      
      <div class="register-diagram mt-3" style="border: 2px solid #333; padding: 2px; font-size: 0.8em; width: 700px; max-width: 700px;">
  <div class="register-bits d-flex">
    <div class="pci-bit-group" style="width: 4%;" title="Enable bit - Set to 1 to enable config space access">
      <div class="pci-bit-label">31</div>
      <div class="pci-bit-field enable" id="enableBit">E</div>
    </div>
    <div class="pci-bit-group" style="width: 21.875%;" title="Reserved bits - Must be set to 0">
      <div class="pci-bit-label">30-24</div>
      <div class="pci-bit-field reserved" id="reservedBits">Reserved</div>
    </div>
    <div class="pci-bit-group" style="width: 25%;" title="Bus Number - Identifies the PCI bus (0-255)">
      <div class="pci-bit-label">23-16</div>
      <div class="pci-bit-field bus" id="busBits">Bus</div>
    </div>
    <div class="pci-bit-group" style="width: 15.625%;" title="Device Number - Identifies the device on the bus (0-31)">
      <div class="pci-bit-label">15-11</div>
      <div class="pci-bit-field device" id="deviceBits">Device</div>
    </div>
    <div class="pci-bit-group" style="width: 9.375%;" title="Function Number - Identifies the function within the device (0-7)">
      <div class="pci-bit-label">10-8</div>
      <div class="pci-bit-field function" id="functionBits">Function</div>
    </div>
    <div class="pci-bit-group" style="width: 25%;" title="Register Offset - Byte offset in config space, must be DWORD aligned">
      <div class="pci-bit-label">7-2</div>
      <div class="pci-bit-field offset" id="offsetBits">Register Offset</div>
    </div>
    <div class="pci-bit-group" style="width: 6.25%;" title="Reserved bits - Must be set to 00 for DWORD alignment">
      <div class="pci-bit-label">1-0</div>
      <div class="pci-bit-field reserved" id="alignBits">00</div>
    </div>
  </div>
</div>
      
      <div class="conversion-info mt-3">
        <div class="info-field">
          <label>Bus:</label>
          <span id="busValue">0x00 (0)</span>
        </div>
        <div class="info-field">
          <label>Device:</label>
          <span id="deviceValue">0x00 (0)</span>
        </div>
        <div class="info-field">
          <label>Function:</label>
          <span id="functionValue">0x0 (0)</span>
        </div>
        <div class="info-field">
          <label>Offset:</label>
          <span id="offsetValue">0x00 (0)</span>
        </div>
        <div class="info-field">
          <label>Enable:</label>
          <span id="enableValue">0 (Disabled)</span>
        </div>
      </div>
    </div>
             
        </li>           
        <li><u>CONFIG_DATA</u>: 
          <ul>
            <li>Address: 0xCFC</li>
            <li>Size: 32 bits</li>
            <li>Register Layout: 32 bits are all data</li>
          </ul>
        </li>
        <li><u>Example</u>:
          <pre><code class="language-nasm">mov   dx, 0xcf8         ; CONFIG_ADDRESS port
mov   eax, 0x80000f8f0  ; Bus 0, Device 31, Function 7, Offset 0xF0, Enable bit set          
out   dx, eax           ; Write 0:31.7, 0xF0 to CONFIG_ADDRESS
mov   dl, 0xfc          ; CONFIG_DATA port
mov   eax, 0xfed1c001
out   dx, eax           ; Write 0xFED1C001 to CONFIG_DATA (writes to 0xF0 of 0:31.7)</code></pre>
        </li>
      </ul>


    </div>
  </body>
</html>
